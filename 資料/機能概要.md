# Grouping_photos 設計書

## 本プログラムの目的

本プログラムは、次の2点を目的としたプログラムである。

1. 写真ファイルのファイル名を撮影日時が含まれるファイル名へリネームする
2. 撮影日時ごとにグループを分け、グループごとにディレクトリの作成、写真ファイルのコピーを行う（写真ファイルの構造化を行う）

## 問題背景

前項で示した目的の問題背景として、

1. 写真ファイルのファイル名が撮影日時と連動していない
2. 複数のデバイスから写真ファイルをまとめた場合、ファイル名の命名規則がばらばらである
3. 撮影期間（イベント）単位で写真を閲覧できない

という現状が挙げられる。

これらの現状から、

1. ファイル名が撮影日時と連動していない
   - → ファイル名から、グループを分けられない
2. ファイル名の命名規則がばらばら
   - → 中身の異なる同名のファイルが存在し、上書きしてしまう恐れがある
3. 撮影期間（イベント、出来事）単位で写真を閲覧できない
   - → 写真を振り返る際に手間、不便

という問題が発生しているため、本プログラムでは、この問題の解決を目的とする。

## ユースケース

本プログラムを使用する状況の例として、次の3つを挙げる。

1. 写真をたくさん撮ったけど、カメラには、連番で保存されているだけで、いつ撮ったかぱっと見わからない
2. SDカードの容量がいっぱいになったので、別のSDカードを入れ替えたら、ファイル名の連番が最初からになっちゃった。このままだと、前のSDカードの写真ファイルと一緒に保存できない
3. 一緒に旅行に行った友達からもらった写真と自分で撮った写真を混ぜたら、ファイル名の規則が違うため、うまく並んで表示されない

## プログラムの仕様

本プログラムの仕様を以下に示す。

- 入力：
  - リネーム・構造化したい写真のファイル群
    - 形式：ディレクトリパス
  - 出力先パス
- 処理：
  1. 入力ディレクトリ内の写真ファイルのファイル名を撮影日時が含まれるファイル名へリネーム
  2. 撮影日時ごとにグループを分け、グループごとにディレクトリの作成、写真ファイルのコピー（写真ファイルの構造化）
- 出力：処理適用済みのディレクトリ
  - 出力先パスへ作成

---

## プログラムの流れ

本プログラムは大きく2つの機能から構成されている。

1. ファイルのリネーム
2. ファイルパスの構造化

これらの機能を元に、本プログラムの大きな流れは次のようになる。

1. リネーム・構造化したい写真のファイルが入ったディレクトリを入力する
2. 入力ディレクトリ内の写真ファイルを検索し、出力ディレクトリへコピーする
3. ファイルをリネームする
4. ファイルパスの構造化（ディレクトリの作成、ファイルの移動）を行う

先に入力ディレクトリのファイルを出力ディレクトリにコピーする根拠だが、写真ファイルを扱うため、既存のデータを直接操作した際のデータの損失を防ぐためである。

次に、それぞれの機能の流れを以下に説明する。

### **1. ファイルのリネーム**

本機能では、ファイル名を撮影日時と連番を含んだファイル名へ変更する。

連番を含む根拠は、撮影日時だけでは同時刻に撮影されたファイルが存在する可能性があるためである。

本プログラムで用いる連番とは、撮影日日時が同刻のファイルがあった場合、それぞれのファイルにユニーク性を持たせるために用いる連続した番号のことをいう。

ここでは、「撮影日時（YYYY-MM-DD:hh:mm:ss)_連番(3桁).(拡張子)」といった構成とする。例として、「2020-05-19:11:53:45_001.png」を示す。
この規則を本資料では「ファイル名フォーマット」と呼ぶこととする。

余談だが、今後の展望としてファイル名の規則を自由に変更できても良いと考える。

#### 「ファイルのリネーム」機能の流れ

次に、機能の流れを以下に示す。

1. 写真ファイルの入ったディレクトリを指定する
2. ディレクトリ内（サブディレクトリも含む）の写真ファイル（拡張子別途指定）を全て検索し、ファイル名と撮影日時を取得する
3. 撮影日時で昇順ソートを行う
   1. 同撮影日時のファイルが複数あった場合、作成日時で昇順ソートを行う
      1. 同作成日時が複数あった場合、現在のファイル名で昇順ソートを行う
4. ファイル名フォーマットを取得する
5. 全ての写真ファイルに対して、ファイル名フォーマットを適用したファイル名に変更する

#### ファイル名フォーマットの取得方法について

ファイル名フォーマットを構成する要素として、

- 撮影日時（YYYY-MM-DD:hh:mm:ss)
- 連番（000)
- 拡張子
  
が必要である。

##### ファイル名フォーマットの取得の流れ

1. 修正後のファイル名を保存する領域を確保する
2. 昇順ソートをした入力ファイルデータから、撮影日時を取得し、同撮影日時のファイルを探す
3. もし、同撮影日時のファイルが複数存在する場合は、撮影日時をもとに連番処理をする
4. 同撮影日時のファイルが存在しない、または、連番処理が終了した場合、修正後のファイル名を保存する領域に格納する
5. 全ての入力ファイルに対して実行する

##### 撮影日時の取得方法

1. 写真ファイルを読み込み、
   1. EXIFタグから「撮影日時」を取得する
   2. または、「ファイル作成日時」を取得する

##### 連番の取得方法

目的：同撮影日時のファイルに連番を付ける

1. 同撮影日時の複数のファイルに対し、ファイルの作成日時を昇順ソートし、存在する数分カウントアップする
2. ファイル作成日時が同じだった場合、現在のファイル名から、昇順ソートし、昇順側からカウントアップする

##### 拡張子の取得方法

1. 入力ディレクトリ内で取得した写真ファイルのファイル名から、`strrchr()` 関数を使って取得する

---

### **2. ファイルパスの構造化**

本機能では、入力ディレクトリ内の写真データを撮影日時ごとにグループ分けをし、入力ディレクトリ以下の階層構造を、グループに合わせて構造化し、出力ディレクトリへ出力する。

#### グループとは

本プログラムで用いる「グループ」とは、ある撮影日時を開始点とし、そこからある時間間隔が経過した時点を終了点とした時間範囲に当てはまる写真ファイルのことと定義する。
また、グループの名前をその時間範囲の開始点を用いることとする。

例えば、2020/05/01 を開始点とし、2020/05/31 を終了点とした場合、この時間範囲内の撮影時間に該当する写真ファイル群を、「2020/05/01グループ」と呼ぶ。

#### 「ファイルパスの構造化」機能の流れ

次に機能の流れを以下に示す。

1. 入力ディレクトリから取得できた写真ファイルから、別途指定した時間間隔ごとの撮影日時で区切り、グループ化する。
2. 作成したグループごとにフォルダを作成し、そのグループに該当する写真ファイルをコピーする。
